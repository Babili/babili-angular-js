!function(){"use strict";var a=angular.module("babili",["ngResource"]),b=null,c=null,d=null;a.provider("babili",function(){var e=this;e.options={apiUrl:"babili-api",socketUrl:"",aliveInterval:3e4},e.configure=function(a){Object.keys(a).forEach(function(b){e.options[b]=a[b]})},e.$get=["$q","$interval",function(f,g){Object.keys(e.options).forEach(function(b){a.constant(b,e.options[b])});var h=e.options.aliveInterval,i=angular.injector(["babili"]);return{headers:function(){var a={Authorization:"Bearer "+b};return a},token:function(){return b},connect:function(a,e){var j=f.defer();return void 0===d||null===d?(b=e,i.get("BabiliMe").get().then(function(a){d=a;var b=function(){d.updateAliveness()};b(),c=g(b,h),j.resolve(d)})["catch"](function(a){j.reject(a)})):(console.err("Babili: /!\\ You should call 'babili.connect' only once."),j.resolve(d)),j.promise},disconnect:function(){var a=f.defer();return b=null,g.cancel(c),a.promise}}}]})}(),function(){"use strict";angular.module("babili").factory("BabiliMe",["$http","$q","babili","apiUrl","BabiliRoom","BabiliMessage","babiliUtils",function(a,b,c,d,e,f,g){var h=function(a){this.id=a.id,this.rooms=[],this.openedRooms=[],this.unreadMessageCount=0,this.roomCount=0,a.meta&&(this.unreadMessageCount=a.meta.unreadMessageCount||0,this.roomCount=a.meta.roomCount||0)};return h.get=function(){return a({method:"GET",url:d+"/user",headers:c.headers()}).then(function(a){return new h(a.data.data)})},h.prototype.updateAliveness=function(){return a({method:"PUT",url:d+"/user/alive",headers:c.headers(),data:{data:{type:"alive"}}})},h.prototype.fetchRooms=function(a){var b=this;return e.query(a).then(function(a){return a.forEach(function(a){b.roomWithId(a.id)||b.addRoom(a),a.open!==!0||b.openedRoomWithId(a.id)||b.openedRooms.push(a)}),a})},h.prototype.fetchOpenedRooms=function(){return this.fetchRooms({onlyOpened:!0})},h.prototype.fetchClosedRooms=function(){return this.fetchRooms({onlyClosed:!0})},h.prototype.fetchMoreRooms=function(){return this.fetchRooms({firstSeenRoomId:this.firstSeenRoom.id})},h.prototype.fetchRoomByIds=function(a){return this.fetchRooms({"roomIds[]":a})},h.prototype.roomWithId=function(a){var b=g.findIndex(this.rooms,function(b){return b.id===a});return this.rooms[b]},h.prototype.openedRoomWithId=function(a){var b=g.findIndex(this.openedRooms,function(b){return b.id===a});return this.openedRooms[b]},h.prototype.hasRoomOpened=function(a){return Boolean(this.openedRoomWithId(a.id))},h.prototype.addRoom=function(a){(!this.firstSeenRoom||this.firstSeenRoom.lastActivityAt>a.lastActivityAt)&&(this.firstSeenRoom=a),this.rooms.push(a)},h.prototype.openRoom=function(a){var c=this,d=b.defer();return c.hasRoomOpened(a)?d.resolve():a.openMembership().then(function(){c.openedRooms.push(a),a.markAllMessageAsRead().then(function(a){c.unreadMessageCount=Math.max(c.unreadMessageCount-a,0)}),d.resolve(a)})["catch"](function(a){d.reject(a)}),d.promise},h.prototype.closeRoom=function(a){var c=this,d=b.defer();return c.hasRoomOpened(a)?a.closeMembership().then(function(){var b=g.findIndex(c.openedRooms,function(b){return b.id===a.id});b>-1&&c.openedRooms.splice(b,1),d.resolve(a)}):d.resolve(),d.promise},h.prototype.closeRooms=function(a){var c=this,d=a.map(function(a){return c.closeRoom(a)});return b.all(d)},h.prototype.openRoomAndCloseOthers=function(a){var b=this,c=b.openedRooms.filter(function(b){return b.id!==a.id});return b.closeRooms(c).then(function(){return b.openRoom(a)})},h.prototype.hasOpenedRooms=function(){return this.openedRooms.length>0},h.prototype.createRoom=function(a,b){var c=this;return e.create(a,c.id,b).then(function(a){return c.addRoom(a),a})},h.prototype.addUserToRoom=function(a,b){return a.addUser(b)},h.prototype.sendMessage=function(a,c){var d=b.defer(),e=this;return c&&c.content?a?f.save({roomId:a.id},c).then(function(b){var c=e.roomWithId(a.id);c.messages.push(b),d.resolve(b)})["catch"](function(a){d.reject(a)}):d.reject(new Error("Room need to be defined.")):d.resolve(null),d.promise},h.prototype.messageSentByMe=function(a){return a&&this.id===a.senderId},h.prototype.unreadMessageCount=function(){var a=0;return this.rooms.forEach(function(b){a+=b.unreadMessageCount}),a},h.prototype.deleteMessage=function(a){var c=b.defer(),d=this;return a?f["delete"]({id:a.id,roomId:a.roomId}).then(function(){var b=d.roomWithId(a.roomId),e=g.findIndex(b.messages,function(b){return b.id===a.id});b.messages.splice(e,1),c.resolve()})["catch"](function(a){c.reject(a)}):c.resolve(null),c.promise},h}])}(),function(){"use strict";angular.module("babili").factory("BabiliMembership",["$http","babili","apiUrl",function(a,b,c){var d=function(a){};return d}])}(),function(){"use strict";angular.module("babili").factory("BabiliMessage",["$http","babili","apiUrl",function(a,b,c){var d=function(a){};return d}])}(),function(){"use strict";angular.module("babili").factory("BabiliRoom",["$http","babili","$q","apiUrl","BabiliUser","BabiliMessage","BabiliMembership",function(a,b,c,d,e,f,g){var h=function(a){this.id=a.id,this.lastActivityAt=a.attributes.lastActivityAt,this.name=a.attributes.name,this.open=a.attributes.open,this.unreadMessageCount=a.attributes.unreadMessageCount,this.users=[],this.messages=[],a.relationships&&(a.relationships.users&&(this.users=a.relationships.users.data.map(function(a){return new e(a)})),a.relationships.messages&&(this.messages=a.relationships.messages.data.map(function(a){return new f(a)})),a.relationships.initiator&&(this.initiator=new e(a.relationships.initiator)))};return h.query=function(c){return a({method:"GET",url:d+"/user/rooms",headers:b.headers(),params:c}).then(function(a){return a.data.data.map(function(a){return new h(a)})})},h.create=function(c,e,f){return a({method:"POST",url:d+"/user/rooms",headers:b.headers(),data:{data:{type:"room",attributes:{name:c},relationships:{users:{data:f.concat(e).map(function(a){return{type:"room",id:a}})}}}}}).then(function(a){return console.log("NEW ROOM",a),new h(a.data)})},h.prototype.updateMembership=function(c){var e=this;return a({method:"PUT",url:d+"/user/rooms/"+this.id+"/membership",headers:b.headers(),data:{data:{type:"membership",attributes:c}}}).then(function(a){e.open=a.data.data.attributes.open})},h.prototype.update=function(){var c=this;return a({method:"PUT",url:d+"/user/rooms/"+this.id,headers:b.headers(),data:{data:{type:"room",attributes:{name:c.name}}}}).then(function(a){c.name=a.data.data.attributes.name})},h.prototype.openMembership=function(){return this.updateMembership({open:!0})},h.prototype.closeMembership=function(){return this.updateMembership({open:!1})},h.prototype.markAllMessageAsRead=function(){var a=this,b=c.defer();return a.unreadMessageCount>0?h.read({id:this.id}).then(function(c){a.unreadMessageCount=0,b.resolve(c.readMessageCount)}):b.resolve(0),b.promise},h.prototype.addUser=function(a){var b=this;return g.save({roomId:b.id},{userId:a}).then(function(a){return b.users.push(a.user),a})},h.prototype.fetchMoreMessages=function(){var a=this,b={roomId:a.id,firstSeenMessageId:a.messages[0].id};return f.query(b).then(function(b){return a.messages.unshift.apply(a.messages,b),b})},h}])}(),function(){"use strict";angular.module("babili").factory("babiliSocket",["babili","socketUrl","$q",function(a,b,c){var d,e={initialize:function(c){d=io.connect(b,{query:"token="+a.token()}),d.on("connect",function(){c(null,d)})},disconnect:function(){var a=c.defer();return d?d.disconnect(function(){a.resolve()}):a.resolve(),a.promise}};return e}])}(),function(){"use strict";angular.module("babili").factory("BabiliUser",function(){var a=function(a){this.id=a.id,a.attributes&&(this.status=a.attributes.status)};return a})}(),function(){"use strict";angular.module("babili").factory("babiliUtils",function(){var a={findIndex:function(a,b){for(var c,d=a.length,e=0;d>e;e+=1)if(c=a[e],b(c))return e;return-1}};return a})}();