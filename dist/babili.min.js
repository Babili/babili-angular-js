!function(){"use strict";var a=angular.module("babili",["ipCookie","ngResource"]);a.provider("babiliHelper",function(){this.options={apiUrl:"babili-api",socketUrl:"",cookieName:"babili_token",aliveInterval:3e4,fetchUserFunction:null},this.initialize=function(b){this.options=_.extend(this.options,b),_.forEach(this.options,function(b,c){a.constant(c,b)})},this.$get=["$q","$interval","$http","$rootScope","ipCookie",function(a,b,c,d,e){var f=null,g=this.options.aliveInterval,h=angular.injector(["babili","ipCookie"]),i=h.get("babiliSocket"),j=function(a,b){return function(c){var e=a.roomWithId(c.roomId);void 0!==e&&null!==e?b.$apply(function(){e.messages.push(c)}):h.get("BabiliRoom").get({id:c.roomId},function(b){a.rooms.push(b),e=b}),a.hasRoomOpened(e)||d.$apply(function(){e.unreadMessageCount=e.unreadMessageCount+1})}};return{start:function(c){var d=a.defer();return h.get("BabiliMe").get(function(a){console.log("FIRST GET2"),i.initialize(function(b,d){d.on("new message",j(a,c))});var e=function(){h.get("BabiliAlive").save({})};e(),console.log("FIRST POST"),f=b(e,g),d.resolve(a)},function(a){d.reject(a)}),d.promise}}}]})}(),function(){"use strict";angular.module("babili").factory("BabiliAlive",["$resource","apiUrl","ipCookie",function(a,b,c){var d=function(){return{"X-XSRF-BABILI-TOKEN":c("XSRF-BABILI-TOKEN")}};return a(b+"/client/alive",{},{save:{method:"POST",withCredentials:!0,headers:d()}})}])}(),function(){"use strict";angular.module("babili").factory("BabiliMe",["$resource","$q","apiUrl","ipCookie","BabiliRoom","BabiliMessage",function(a,b,c,d,e,f){var g=function(){return{"X-XSRF-BABILI-TOKEN":d("XSRF-BABILI-TOKEN")}},h=a(c+"/client/me",{},{get:{method:"GET",withCredentials:!0,headers:g(),transformResponse:function(a){var b=angular.fromJson(a);return b.rooms&&(b.rooms=b.rooms.map(function(a){return new e(a)})),(null===b.openedRoomIds||void 0===b.openedRoomIds)&&(b.openedRoomIds=[]),b}}}),i=function(a,b){e.open({id:a.id},b)},j=function(a,b){e.close({id:a.id},b)};return h.prototype.rooms=function(){return this.rooms},h.prototype.roomWithId=function(a){return _.find(this.rooms,function(b){return b.id===a})},h.prototype.hasRoomOpened=function(a){return _.includes(this.openedRoomIds,a.id)},h.prototype.openRoom=function(a){var c=this,d=b.defer();return c.hasRoomOpened(a)||i(a,function(){c.openedRoomIds.push(a.id),a.markAllMessageAsRead(),d.resolve(a)}),d.promise},h.prototype.closeAllRooms=function(){this.openedRoomIds=[]},h.prototype.openSingleRoom=function(a){return this.openedRoomIds=[],this.openRoom(a)},h.prototype.closeRoom=function(a){var c=this,d=b.defer();return c.hasRoomOpened(a)&&j(a,function(){_.remove(c.openedRoomIds,function(b){return b===a.id}),d.resolve()}),d.promise},h.prototype.hasOpenedRooms=function(){return!_.isEmpty(this.openedRoomIds)},h.prototype.openedRooms=function(){var a=this;return _.filter(a.rooms,function(b){return _.includes(a.openedRoomIds,b.id)})},h.prototype.createRoom=function(a,c){var d=this,f=b.defer(),g=new e({name:a,userIds:c.concat(d.id)});return e.save(g,function(a){var b=d.roomWithId(a.id);null!==b&&void 0!==b?f.resolve(b):(d.rooms.push(a),f.resolve(a))},function(a){f.reject(a)}),f.promise},h.prototype.updateRoom=function(a){var c=this,d=b.defer();return a.update().then(function(b){var e=_.findIndex(c.rooms,function(b){return a.id===b.id});c.rooms[e]=b,d.resolve()})["catch"](function(a){d.reject(a)}),d.promise},h.prototype.addUserToRoom=function(a,b){return a=this.roomWithId(a.id),a.addUser(this,b)},h.prototype.sendMessage=function(a,c){var d=b.defer(),e=this;return f.save({roomId:a.id},c,function(b){e.roomWithId(a.id).messages.push(b),d.resolve(b)},function(a){d.reject(a)}),d.promise},h}])}(),function(){"use strict";angular.module("babili").factory("BabiliMembership",["$resource","apiUrl","ipCookie",function(a,b,c){var d=function(){return{"X-XSRF-BABILI-TOKEN":c("XSRF-BABILI-TOKEN")}};return a(b+"/client/rooms/:roomId/memberships/:id",{membershipId:"@membershipId",id:"@id"},{save:{method:"POST",withCredentials:!0,headers:d()}})}])}(),function(){"use strict";angular.module("babili").factory("BabiliMessage",["$resource","apiUrl","ipCookie",function(a,b,c){var d=function(){return{"X-XSRF-BABILI-TOKEN":c("XSRF-BABILI-TOKEN")}};return a(b+"/client/rooms/:roomId/messages/:id",{roomId:"@roomId",id:"@id"},{save:{method:"POST",withCredentials:!0,headers:d()},get:{method:"GET",withCredentials:!0,headers:d()},query:{method:"GET",withCredentials:!0,isArray:!0,headers:d()},"delete":{method:"delete",withCredentials:!0,headers:d()}})}])}(),function(){"use strict";angular.module("babili").factory("BabiliRoom",["$resource","$q","apiUrl","ipCookie","BabiliMessage","BabiliMembership",function(a,b,c,d,e,f){var g=function(){var a={"X-XSRF-BABILI-TOKEN":d("XSRF-BABILI-TOKEN")};return console.log("headers",a),a},h=a(c+"/client/rooms/:id",{id:"@id"},{get:{method:"GET",withCredentials:!0,headers:g()},update:{method:"PUT",withCredentials:!0,headers:g()},"delete":{method:"DELETE",withCredentials:!0,headers:g()},read:{url:c+"/client/rooms/:id/read",params:{id:"@id"},withCredentials:!0,method:"POST",headers:g()},open:{url:c+"/client/rooms/:id/open",params:{id:"@id"},withCredentials:!0,method:"POST",headers:g()},close:{url:c+"/client/rooms/:id/open",params:{id:"@id"},withCredentials:!0,method:"DELETE",headers:g()}});return h.prototype.markAllMessageAsRead=function(){var a=this;a.unreadMessageCount>0&&h.read({id:this.id},function(){a.unreadMessageCount=0})},h.prototype.lastMessage=function(){return _.last(this.messages)},h.prototype.addUser=function(a,c){var d=b.defer(),e=this;return f.save({roomId:e.id},{userId:c},function(a){e.users.push(a.user),d.resolve()},function(a){d.reject(a)}),d.promise},h.prototype.update=function(){var a=b.defer(),c={name:this.name};return h.update({id:this.id},c,function(b){a.resolve(b)},function(b){a.reject(b)}),a.promise},h}])}(),function(){"use strict";angular.module("babili").factory("babiliSocket",["ipCookie","socketUrl","cookieName",function(a,b,c){var d={initialize:function(d){var e=a(c),f=io.connect(b,{query:"token="+e});f.on("connect",function(){d(null,f)})}};return d}])}();