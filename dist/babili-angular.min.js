!function(){"use strict";var e=angular.module("babili",["ng"]),t=null,n=null,o=null;e.provider("babili",function(){var r=this;r.options={apiUrl:"http://api.babili.local",socketUrl:"http://pusher.babili.local",aliveInterval:3e4},r.configure=function(e){Object.keys(e).forEach(function(t){r.options[t]=e[t]})},r.$get=["$q","$interval",function(s,i){Object.keys(r.options).forEach(function(t){e.constant(t,r.options[t])});var a=r.options.aliveInterval,u=angular.injector(["babili"]),d=function(e){return function(t){var n=u.get("BabiliMessage"),r=new n(t.data),s=o.roomWithId(r.room.id);void 0!==s&&null!==s?e.$apply(function(){s.addMessage(r),o.hasRoomOpened(s)||(s.unreadMessageCount=s.unreadMessageCount+1,o.unreadMessageCount=o.unreadMessageCount+1)}):u.get("BabiliRoom").get(r.room.id).then(function(t){o.addRoom(t),s=t,o.hasRoomOpened(s)||e.$apply(function(){s.unreadMessageCount=s.unreadMessageCount,o.unreadMessageCount=o.unreadMessageCount+1})})}};return{headers:function(){var e={Authorization:"Bearer "+t};return e},token:function(){return t},connect:function(e,r){var c=s.defer(),h=function(){if(!u.get("babiliSocket").socketExist()){var t=u.get("babiliSocket").connect();t.on("new message",d(e)),t.on("connected",function(e){o.deviceSessionId=e.deviceSessionId})}};return void 0===o||null===o?(t=r,u.get("BabiliMe").get().then(function(e){o=e,h();var t=function(){o.updateAliveness()};t(),n=i(t,a),c.resolve(o)})["catch"](function(e){c.reject(e)})):(h(),c.resolve(o)),c.promise},disconnect:function(){i.cancel(n),u.get("babiliSocket").disconnect(),t=null,n=null,o=null}}}]})}(),function(){"use strict";angular.module("babili").factory("BabiliMe",["$http","$q","babili","apiUrl","BabiliRoom","BabiliMessage","babiliUtils",function(e,t,n,o,r,s,i){var a=function(e){this.id=e.id,this.rooms=[],this.openedRooms=[],this.unreadMessageCount=0,this.roomCount=0,e.meta&&(this.unreadMessageCount=e.meta.unreadMessageCount||0,this.roomCount=e.meta.roomCount||0)};return a.get=function(){return e({method:"GET",url:o+"/user",headers:n.headers()}).then(function(e){return new a(e.data.data)})},a.prototype.updateAliveness=function(){return e({method:"PUT",url:o+"/user/alive",headers:n.headers(),data:{data:{type:"alive"}}})},a.prototype.fetchRooms=function(e){var t=this;return r.query(e).then(function(e){return e.forEach(function(e){t.roomWithId(e.id)||t.addRoom(e),e.open!==!0||t.openedRoomWithId(e.id)||t.openedRooms.push(e)}),e})},a.prototype.fetchOpenedRooms=function(){return this.fetchRooms({onlyOpened:!0})},a.prototype.fetchClosedRooms=function(){return this.fetchRooms({onlyClosed:!0})},a.prototype.fetchMoreRooms=function(){return this.fetchRooms({firstSeenRoomId:this.firstSeenRoom.id})},a.prototype.fetchRoomByIds=function(e){return this.fetchRooms({"roomIds[]":e})},a.prototype.roomWithId=function(e){var t=i.findIndex(this.rooms,function(t){return t.id===e});return this.rooms[t]},a.prototype.openedRoomWithId=function(e){var t=i.findIndex(this.openedRooms,function(t){return t.id===e});return this.openedRooms[t]},a.prototype.hasRoomOpened=function(e){return Boolean(this.openedRoomWithId(e.id))},a.prototype.addRoom=function(e){(!this.firstSeenRoom||this.firstSeenRoom.lastActivityAt>e.lastActivityAt)&&(this.firstSeenRoom=e);var t=i.findIndex(this.rooms,function(t){return t.id===e.id});t>-1?this.rooms[t]=e:this.rooms.push(e)},a.prototype.openRoom=function(e){var n=this,o=t.defer();return n.hasRoomOpened(e)?o.resolve():e.openMembership().then(function(){n.openedRooms.push(e);var t;e.messages.length>0&&(t=e.messages[e.messages.length-1].id),e.markAllMessageAsRead(t).then(function(e){n.unreadMessageCount=Math.max(n.unreadMessageCount-e,0)}),o.resolve(e)})["catch"](function(e){o.reject(e)}),o.promise},a.prototype.closeRoom=function(e){var n=this,o=t.defer();return n.hasRoomOpened(e)?e.closeMembership().then(function(){var t=i.findIndex(n.openedRooms,function(t){return t.id===e.id});t>-1&&n.openedRooms.splice(t,1),o.resolve(e)}):o.resolve(),o.promise},a.prototype.closeRooms=function(e){var n=this,o=e.map(function(e){return n.closeRoom(e)});return t.all(o)},a.prototype.openRoomAndCloseOthers=function(e){var t=this,n=t.openedRooms.filter(function(t){return t.id!==e.id});return t.closeRooms(n).then(function(){return t.openRoom(e)})},a.prototype.hasOpenedRooms=function(){return this.openedRooms.length>0},a.prototype.createRoom=function(e,t,n){var o=this;return r.create(e,o.id,t,n).then(function(e){return o.addRoom(e),e})},a.prototype.updateRoom=function(e){var t=this;return e.update().then(function(e){var n=t.roomWithId(e.id);return n.name=e.name,n})},a.prototype.addUserToRoom=function(e,t){return e.addUser(t)},a.prototype.sendMessage=function(e,n){var o=this,r=t.defer();return n&&n.content?e?(n.deviceSessionId=o.deviceSessionId,s.create(e,n).then(function(t){e.addMessage(t),r.resolve(t)})["catch"](function(e){r.reject(e)})):r.reject(new Error("Room need to be defined.")):r.resolve(null),r.promise},a.prototype.messageSentByMe=function(e){return e&&e.sender&&this.id===e.sender.id},a.prototype.deleteMessage=function(e){var n=t.defer(),o=this;return e?s["delete"](e).then(function(){var t=o.roomWithId(e.room.id),r=i.findIndex(t.messages,function(t){return t.id===e.id});t.messages.splice(r,1),n.resolve()})["catch"](function(e){n.reject(e)}):n.resolve(null),n.promise},a}])}(),function(){"use strict";angular.module("babili").factory("BabiliMessage",["$http","babili","apiUrl","BabiliUser",function(e,t,n,o){var r=function(e){var t=angular.injector(["babili"]).get("BabiliRoom");this.id=e.id,this.content=e.attributes.content,this.contentType=e.attributes.contentType,this.createdAt=new Date(e.attributes.createdAt),this.room=new t(e.relationships.room.data),e.relationships.sender&&(this.sender=new o(e.relationships.sender.data))};return r.create=function(o,s){return e({method:"POST",url:n+"/user/rooms/"+o.id+"/messages",headers:t.headers(),data:{data:{type:"message",attributes:{content:s.content,contentType:s.contentType,deviceSessionId:s.deviceSessionId}}}}).then(function(e){return new r(e.data.data)})},r.query=function(o,s){return e({method:"GET",url:n+"/user/rooms/"+o.id+"/messages",headers:t.headers(),params:s}).then(function(e){return e.data.data.map(function(e){return new r(e)})})},r["delete"]=function(o){return e({method:"delete",url:n+"/user/rooms/"+o.room.id+"/messages/"+o.id,headers:t.headers()})},r}])}(),function(){"use strict";angular.module("babili").factory("BabiliRoom",["$http","babili","$q","apiUrl","BabiliUser","BabiliMessage","babiliUtils",function(e,t,n,o,r,s,i){var a=function(e){this.id=e.id,this.users=[],this.messages=[],e.attributes&&(this.lastActivityAt=e.attributes.lastActivityAt,this.name=e.attributes.name,this.open=e.attributes.open,this.unreadMessageCount=e.attributes.unreadMessageCount),e.relationships&&(e.relationships.users&&(this.users=e.relationships.users.data.map(function(e){return new r(e)})),e.relationships.messages&&(this.messages=e.relationships.messages.data.map(function(e){return new s(e)})),e.relationships.initiator&&(this.initiator=new r(e.relationships.initiator)))};return a.get=function(n){return e({method:"GET",url:o+"/user/rooms/"+n,headers:t.headers()}).then(function(e){return new a(e.data.data)})},a.query=function(n){return e({method:"GET",url:o+"/user/rooms",headers:t.headers(),params:n}).then(function(e){return e.data.data.map(function(e){return new a(e)})})},a.create=function(n,r,s,i){var u=i&&i.noDuplicate===!0;return e({method:"POST",url:o+"/user/rooms?noDuplicate="+u,headers:t.headers(),data:{data:{type:"room",attributes:{name:n},relationships:{users:{data:s.map(function(e){return{type:"user",id:e}})}}}}}).then(function(e){return new a(e.data.data)})},a.prototype.updateMembership=function(n){var r=this;return e({method:"PUT",url:o+"/user/rooms/"+this.id+"/membership",headers:t.headers(),data:{data:{type:"membership",attributes:n}}}).then(function(e){return r.open=e.data.data.attributes.open,r})},a.prototype.update=function(){var n=this;return e({method:"PUT",url:o+"/user/rooms/"+this.id,headers:t.headers(),data:{data:{type:"room",attributes:{name:n.name}}}}).then(function(e){return n.name=e.data.data.attributes.name,n})},a.prototype.addUser=function(n){var s=this;return e({method:"POST",url:o+"/user/rooms/"+this.id+"/memberships",headers:t.headers(),data:{data:{type:"membership",relationships:{user:{data:{type:"user",id:n}}}}}}).then(function(e){return s.users.push(new r(e.data.data.relationships.user.data)),s})},a.prototype.messageWithId=function(e){var t=i.findIndex(this.messages,function(t){return t.id===e});return this.messages[t]},a.prototype.openMembership=function(){return this.updateMembership({open:!0})},a.prototype.closeMembership=function(){return this.updateMembership({open:!1})},a.prototype.addMessage=function(e){this.messages.push(e)},a.prototype.markAllMessageAsRead=function(r){var s=this,i=n.defer();return s.unreadMessageCount>0?e({method:"PUT",url:o+"/user/rooms/"+this.id+"/membership/unread-messages",headers:t.headers(),data:{lastReadMessageId:r}}).then(function(e){s.unreadMessageCount=0,i.resolve(e.readMessageCount)}):(i.resolve(0),i.promise)},a.prototype.fetchMoreMessages=function(){var e=this,t={firstSeenMessageId:e.messages[0].id};return s.query(e,t).then(function(t){return e.messages.unshift.apply(e.messages,t),t})},a}])}(),function(){"use strict";angular.module("babili").factory("babiliSocket",["babili","socketUrl",function(e,t){var n={connect:function(){return this.ioSocket=io.connect(t,{query:"token="+e.token(),forceNew:!0}),this.ioSocket},disconnect:function(){this.ioSocket&&(this.ioSocket.close(!0),this.ioSocket=void 0)},socketExist:function(){return null!==this.ioSocket&&void 0!==this.ioSocket}};return n}])}(),function(){"use strict";angular.module("babili").factory("BabiliUser",function(){var e=function(e){this.id=e.id,e.attributes&&(this.status=e.attributes.status)};return e})}(),function(){"use strict";angular.module("babili").factory("babiliUtils",function(){var e={findIndex:function(e,t){for(var n,o=e.length,r=0;o>r;r+=1)if(n=e[r],t(n))return r;return-1}};return e})}();